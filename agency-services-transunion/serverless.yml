# NOTE: update this with your service name
service: agency-services-transunion

# Create an optimized package for our functions
package:
  individually: true

plugins:
  - serverless-bundle # Package our functions with Webpack
  - serverless-offline
  - serverless-dotenv-plugin # Load .env as environment variables

custom:
  bundle:
    linting: false

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-2'}
  endpointType: PRIVATE
  vpcEndpointIds:
    - !Ref ApiVpcEndpoint
  vpc:
    securityGroupIds:
      - !GetAtt VpcEndpointLambdaSecurityGroup.GroupId
    subnetIds:
      - !Ref SubnetAPrivate
      - !Ref SubnetBPrivate
      - !Ref SubnetCPrivate
  resourcePolicy:
    - Effect: Allow
      Principal: '*'
      Action: execute-api:Invoke
      Resource:
        - !Sub 'arn:aws:execute-api:${AWS::AccountId}:*'
    - Effect: Deny
      Principal: '*'
      Action: execute-api:Invoke
      Resource:
        - !Sub 'arn:aws:execute-api:${AWS::AccountId}:*'
      Condition:
        StringNotEquals:
          aws:sourceVpce:
            - !Ref ApiVpcEndpoint

functions:
  test:
    handler: src/handlers/test.main
    events:
      - http:
          path: /test
          method: get
          cors: true
          caching:
            enabled: true

resources:
  Resources:
    VPC:
      Type: 'AWS::EC2::VPC'
      Properties:
        CidrBlock: !Sub '10.0.0.0/16'
        EnableDnsSupport: true
        EnableDnsHostnames: true
        InstanceTenancy: default
    SubnetAPrivate:
      Type: 'AWS::EC2::Subnet'
      Properties:
        AvailabilityZone: !Select [0, !GetAZs '']
        CidrBlock: !Sub '10.0.128.0/20'
        VpcId: !Ref VPC
    SubnetBPrivate:
      Type: 'AWS::EC2::Subnet'
      Properties:
        AvailabilityZone: !Select [1, !GetAZs '']
        CidrBlock: !Sub '10.0.144.0/20'
        VpcId: !Ref VPC
    SubnetCPrivate:
      Type: 'AWS::EC2::Subnet'
      Properties:
        AvailabilityZone: !Select [2, !GetAZs '']
        CidrBlock: !Sub '10.0.160.0/20'
        VpcId: !Ref VPC
    VpcEndpointSecurityGroup:
      Type: 'AWS::EC2::SecurityGroup'
      Properties:
        VpcId: !Ref VPC
        GroupDescription: 'Security group for VPC Endpoint'
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            SourceSecurityGroupId: !GetAtt VpcEndpointLambdaSecurityGroup.GroupId
    ApiVpcEndpoint:
      Type: AWS::EC2::VPCEndpoint
      Properties:
        PrivateDnsEnabled: True
        SecurityGroupIds:
          - !GetAtt VpcEndpointSecurityGroup.GroupId
        ServiceName: !Sub 'com.amazonaws.${AWS::Region}.execute-api'
        SubnetIds:
          - !Ref SubnetAPrivate
          - !Ref SubnetBPrivate
          - !Ref SubnetCPrivate
        VpcEndpointType: Interface
        VpcId: !Ref VPC
    VpcEndpointLambdaSecurityGroup:
      Type: 'AWS::EC2::SecurityGroup'
      Properties:
        VpcId: !Ref VPC
        GroupDescription: 'Security group for VPC Endpoint Lambda'

  # 'com.amazonaws.us-east-1.sns'

  Outputs:
    VPC:
      Description: 'VPC'
      Value: !Ref VPC
      Export:
        Name: !Sub '${self:service}-vpc'
    SubnetsPrivate:
      Description: 'Subnets private'
      Value: !Join [',', [!Ref SubnetAPrivate, !Ref SubnetBPrivate, !Ref SubnetCPrivate]]
      Export:
        Name: !Sub '${self:service}-subnets-private'
    SecurityGroup:
      Description: 'VPC Endpoint Security Group'
      Value: !Join [',', [!Ref VpcEndpointLambdaSecurityGroup]]
      Export:
        Name: !Sub '${self:service}-vpc-securitygroup'
